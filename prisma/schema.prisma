generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model account_tokens {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  token_hash String
  type       String
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  expires_at DateTime  @db.Timestamptz(6)
  used_at    DateTime? @db.Timestamptz(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model audit_logs {
  id         BigInt   @id @default(autoincrement())
  user_id    String?  @db.Uuid
  actor_id   String?  @db.Uuid
  action     String
  detail     Json?
  ip         String?  @db.Inet
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

model refresh_tokens {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  token_hash String
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  expires_at DateTime  @db.Timestamptz(6)
  revoked_at DateTime? @db.Timestamptz(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model roles {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  user_roles  user_roles[]
}

model sessions {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String   @db.Uuid
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  last_active_at DateTime @default(now()) @db.Timestamptz(6)
  expires_at     DateTime @db.Timestamptz(6)
  user_agent     String?
  ip             String?  @db.Inet
  metadata       Json?
  users          users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model user_roles {
  user_id String @db.Uuid
  role_id Int
  roles   roles  @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users   users  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, role_id])
}

model users {
  id                     String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                  String           @unique
  password_hash          String?
  full_name              String?
  phone                  String?
  username               String?          @unique
  nic_passport_encrypted String?
  role                   role_enum        @default(USER)
  is_verified            Boolean          @default(false)
  is_active              Boolean          @default(true)
  created_at             DateTime         @default(now()) @db.Timestamptz(6)
  updated_at             DateTime         @default(now()) @db.Timestamptz(6)
  account_tokens         account_tokens[]
  refresh_tokens         refresh_tokens[]
  sessions               sessions[]
  user_roles             user_roles[]

  @@index([phone], map: "idx_users_phone")
}

model ad_status_history {
  history_id       Int             @id @default(autoincrement())
  reference_number String?         @db.Char(16)
  status           String          @db.VarChar(20)
  updated_at       DateTime?       @default(now()) @db.Timestamp(6)
  advertisements   advertisements? @relation(fields: [reference_number], references: [reference_number], onDelete: Cascade, onUpdate: NoAction)

  @@index([reference_number], map: "idx_ad_status_history_reference_number")
}

model advertisements {
  ad_id               Int                 @id @default(autoincrement())
  reference_number    String              @unique @db.Char(16)
  advertiser_id       Int?
  newspaper_name      String              @db.VarChar(100)
  ad_type             String              @db.VarChar(50)
  classified_category String?             @db.VarChar(100)
  subcategory         String?             @db.VarChar(100)
  publish_date        DateTime            @db.Date
  advertisement_text  String
  background_color    Boolean?            @default(false)
  post_in_web         Boolean?            @default(false)
  upload_image        String?
  special_notes       String?
  price               Decimal?            @db.Decimal(10, 2)
  status              String?             @default("Pending") @db.VarChar(20)
  created_at          DateTime?           @default(now()) @db.Timestamp(6)
  updated_at          DateTime?           @default(now()) @db.Timestamp(6)
  ad_review_history   ad_review_history[]
  ad_status_history   ad_status_history[]
  advertisers         advertisers?        @relation(fields: [advertiser_id], references: [advertiser_id], onDelete: Cascade, onUpdate: NoAction)
  payment_ads         payment_ads[]
  tracking_tokens     tracking_tokens[]

  @@index([reference_number], map: "idx_advertisements_reference_number")
  @@index([status], map: "idx_advertisements_status")
}

model advertisers {
  advertiser_id  Int              @id @default(autoincrement())
  name           String           @db.VarChar(100)
  nic            String           @db.VarChar(12)
  phone          String           @db.VarChar(15)
  email          String           @db.VarChar(100)
  address        String
  advertisements advertisements[]
}

model ad_review_history {
  id                      Int            @id @default(autoincrement())
  reference_number        String         @db.Char(16)
  attempt                 Int            @default(1)
  advertisement_text      String
  requested_revision_text String?
  reviewed_by             String?        @db.VarChar(100)
  status_now              String         @default("Pending") @db.VarChar(20)
  created_at              DateTime?      @default(now()) @db.Timestamp(6)
  updated_at              DateTime?      @default(now()) @db.Timestamp(6)
  advertisements          advertisements @relation(fields: [reference_number], references: [reference_number], onDelete: Cascade, map: "fk_reference")

  @@index([reference_number], map: "idx_ad_review_reference")
}

model tracking_tokens {
  id             Int            @id @default(autoincrement())
  ad_id          Int
  reference      String         @db.Char(16)
  email          String         @db.VarChar(100)
  token_hash     String         @db.VarChar(128)
  created_at     DateTime?      @default(now()) @db.Timestamp(6)
  last_used_at   DateTime?      @db.Timestamp(6)
  expires_at     DateTime       @db.Timestamp(6)
  revoked        Boolean?       @default(false)
  advertisements advertisements @relation(fields: [ad_id], references: [ad_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_tracking_tokens_ad")

  @@index([reference], map: "idx_tracking_reference")
  @@index([token_hash], map: "idx_tracking_token_hash")
}

model payment_ads {
  id                Int             @id @default(autoincrement())
  reference_number  String?         @db.Char(16)
  file_path         String
  original_filename String?         @db.VarChar(255)
  amount            Decimal?        @db.Decimal(12, 2)
  payment_date      DateTime?       @default(now()) @db.Timestamp(6)
  verified_by       String?
  status            String?         @default("PAYMENTPENDING") @db.VarChar(20)
  remarks           String?
  created_at        DateTime?       @default(now()) @db.Timestamp(6)
  updated_at        DateTime?       @default(now()) @db.Timestamp(6)
  advertisements    advertisements? @relation(fields: [reference_number], references: [reference_number], onDelete: Cascade, onUpdate: NoAction)
}

enum role_enum {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  PREMIUM
  USER
}
